@page "/trainer"
@inject HttpClient Http
@inject IConfiguration Configuration
@inject NavigationManager NavigationManager

<h1>Trainer Dashboard</h1>

@if (repositories == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <select @onchange="OnSelectedRepositoryChanged">
        <option value="">Selecteer een repository</option>
        @foreach (var repo in repositories)
        {
            <option value="@repo.Name">@repo.Name</option>
        }
    </select>

    @if (!string.IsNullOrEmpty(selectedRepositoryId))
    {
        <p>Geselecteerde repository ID: @selectedRepositoryId</p>

        <button @onclick="GenerateStudentLabs">Maak student labs</button>

        @if (labContent == null && errorMessage == null)
        {
            <p><em>Lab inhoud laden...</em></p>
        }
        else if (!string.IsNullOrEmpty(errorMessage))
        {
            <p class="error">@errorMessage</p>
        }
        else
        {
            <h3>Lab inhoud</h3>
            <div class="lab-content">
                @((MarkupString)labContent)
            </div>
        }
    }
}

@code {
    private List<Repository> repositories;
    private string selectedRepositoryId;
    private string labContent;
    private string errorMessage;
    private string githubUsername;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var githubToken = Configuration["GitHubToken"];
            githubUsername = Configuration["GitHubUsername"];
            var functionApiKey = Configuration["FunctionApiKey"];
            var apiUrl = Configuration["FunctionApiUrl"];

            if (!string.IsNullOrEmpty(githubToken))
            {
                Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("token", githubToken);
            }

            // Voeg de function key toe in de URL in plaats van als header
            repositories = await Http.GetFromJsonAsync<List<Repository>>($"{apiUrl}/repositories?code={functionApiKey}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Fout bij het ophalen van repositories: {ex.Message}";
            Console.WriteLine($"Error fetching repositories: {ex.Message}");
        }
    }

    private async Task OnSelectedRepositoryChanged(ChangeEventArgs e)
    {
        selectedRepositoryId = e.Value.ToString();
        labContent = null;
        errorMessage = null;

        try
        {
            var functionApiKey = Configuration["FunctionApiKey"];
            var apiUrl = Configuration["FunctionApiUrl"];

            // Hardcoded branch voor specifieke repository
            string branch = "master";
            if (selectedRepositoryId == "MS-4010-Extend-Microsoft365-Copilot-declarative-agents-VS-Code")
            {
                branch = "main";
            }

            // Voeg function key toe in de URL in plaats van als header
            labContent = await Http.GetStringAsync($"{apiUrl}/repositories/{selectedRepositoryId}/content?ref={branch}&code={functionApiKey}");
            labContent = Markdig.Markdown.ToHtml(labContent);
        }
        catch (Exception ex)
        {
            errorMessage = $"Fout bij het ophalen van lab inhoud: {ex.Message}";
            Console.WriteLine($"Fout bij het ophalen van lab inhoud: {ex.Message}");
        }
        StateHasChanged();
    }

    private void GenerateStudentLabs()
    {
        if (!string.IsNullOrEmpty(selectedRepositoryId))
        {
            NavigationManager.NavigateTo($"/studentlabs/{selectedRepositoryId}");
        }
    }

    public class Repository
    {
        public string Id { get; set; }
        public string Name { get; set; }
    }

    public class GitHubRepository
    {
        public string DefaultBranch { get; set; }
    }
}
